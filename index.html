<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Space War: Master Edition</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #game-container { position: relative; border: 3px solid #00d2ff; box-shadow: 0 0 30px rgba(0, 210, 255, 0.4); }
        canvas { background: #010103; display: block; }
        .ui { position: absolute; top: 10px; left: 15px; width: 94%; display: flex; justify-content: space-between; pointer-events: none; font-size: 18px; z-index: 10; font-weight: bold; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; border: 2px solid #00d2ff; z-index: 20; }
        button { padding: 15px 30px; font-size: 18px; background: #00d2ff; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .lives { color: #ff4d4d; font-size: 24px; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="ui">
            <div>PUNTOS: <span id="score">0</span> | <span class="lives" id="lives">❤❤❤</span></div>
            <div>RECORD: <span id="highscore">0</span></div>
        </div>
        <canvas id="gameCanvas" width="600" height="750"></canvas>
        <div id="menu">
            <h1 id="title">SPACE WAR: MASTER</h1>
            <p id="msg">FLECHAS: Mover | ESPACIO: Disparar<br>R: Reiniciar al morir</p>
            <button onclick="startGame()">INICIAR MISIÓN</button>
        </div>
    </div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const livesEl = document.getElementById("lives");
    const highscoreEl = document.getElementById("highscore");
    const menu = document.getElementById("menu");

    let gameActive = false, score = 0, highscore = localStorage.getItem("sw_master_score") || 0;
    let gameSpeedMult = 1, particles = [];
    highscoreEl.innerText = highscore;

    let player = { 
        x: 300, y: 650, speed: 7, 
        tripleEndTime: 0, shieldEndTime: 0, 
        lives: 3, invincibleUntil: 0 
    };
    
    let bullets = [], enemies = [], enemyBombs = [], stars = [], bonuses = [], boss = null;
    let keys = {};

    for(let i=0; i<80; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2, v: Math.random()*2+1});

    window.onkeydown = e => { 
        keys[e.code] = true; 
        if(e.code === "Space" && gameActive) shoot();
        if(e.code === "KeyR" && !gameActive) startGame();
    };
    window.onkeyup = e => keys[e.code] = false;

    function createExplosion(x, y, color, count = 10) {
        for(let i=0; i<count; i++) {
            particles.push({
                x, y, 
                vx: (Math.random()-0.5)*8, 
                vy: (Math.random()-0.5)*8, 
                life: 30, color
            });
        }
    }

    function shoot() {
        const now = Date.now();
        const v = -12;
        if(now < player.tripleEndTime) {
            bullets.push({x: player.x, y: player.y, vx: -4, vy: v}, {x: player.x, y: player.y, vx: 0, vy: v}, {x: player.x, y: player.y, vx: 4, vy: v});
        } else {
            bullets.push({x: player.x, y: player.y, vx: 0, vy: v});
        }
    }

    function startGame() {
        score = 0; gameSpeedMult = 1; player.lives = 3;
        enemies = []; bullets = []; enemyBombs = []; bonuses = []; boss = null; particles = [];
        player.x = 300; player.y = 650; player.tripleEndTime = 0; player.shieldEndTime = 0;
        livesEl.innerText = "❤❤❤"; scoreEl.innerText = "0";
        gameActive = true; menu.style.display = "none";
        loop();
    }

    function onPlayerHit() {
        const now = Date.now();
        if (now < player.invincibleUntil) return;
        if (now < player.shieldEndTime) {
            player.shieldEndTime = 0;
            player.invincibleUntil = now + 1000;
            createExplosion(player.x, player.y, "#0ff", 20);
            return;
        }
        player.lives--;
        player.invincibleUntil = now + 2000; // 2 segundos de gracia
        livesEl.innerText = "❤".repeat(player.lives);
        createExplosion(player.x, player.y, "#fff", 15);
        if (player.lives <= 0) gameOver();
    }

    function update() {
        if(!gameActive) return;
        const now = Date.now();

        // Movimiento
        if(keys["ArrowLeft"] && player.x > 25) player.x -= player.speed;
        if(keys["ArrowRight"] && player.x < canvas.width - 25) player.x += player.speed;
        if(keys["ArrowUp"] && player.y > 25) player.y -= player.speed;
        if(keys["ArrowDown"] && player.y < canvas.height - 25) player.y += player.speed;

        gameSpeedMult = 1 + (Math.floor(score / 100) * 0.1);

        // Partículas
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            if(p.life <= 0) particles.splice(i, 1);
        });

        stars.forEach(s => { s.y += s.v * gameSpeedMult; if(s.y > canvas.height) s.y = 0; });

        bullets.forEach((b, i) => {
            b.y += b.vy; b.x += b.vx;
            if(b.y < -20 || b.x < 0 || b.x > canvas.width) bullets.splice(i, 1);
        });

        // JEFE
        if(score > 0 && score % 500 === 0 && !boss) {
            boss = { x: canvas.width/2, y: -100, hp: 50, maxHp: 50, dir: 1 };
        }
        if(boss) {
            if(boss.y < 100) boss.y += 1;
            boss.x += 3 * boss.dir * gameSpeedMult;
            if(boss.x > canvas.width - 80 || boss.x < 80) boss.dir *= -1;
            if(Math.random() < 0.05) enemyBombs.push({ x: boss.x, y: boss.y + 30, vy: 5 });
        }

        // Bombas
        enemyBombs.forEach((bomb, i) => {
            bomb.y += 5 * gameSpeedMult;
            if(Math.hypot(bomb.x - player.x, bomb.y - player.y) < 20) {
                onPlayerHit();
                enemyBombs.splice(i, 1);
            }
            if(bomb.y > canvas.height) enemyBombs.splice(i, 1);
        });

        // Enemigos
        if(!boss && Math.random() < 0.04 * gameSpeedMult) {
            let type = Math.random();
            if(type < 0.15) enemies.push({ x: Math.random()*canvas.width, y: -40, type: 'kamikaze', hp: 1, speed: 4, color: "#ffa500" });
            else if(type < 0.3) enemies.push({ x: Math.random()*canvas.width, y: -40, type: 'tank', hp: 3, speed: 1.5, color: "#555" });
            else enemies.push({ x: Math.random()*canvas.width, y: -40, type: 'normal', hp: 1, speed: 3, color: "#f55" });
        }

        enemies.forEach((en, ei) => {
            en.y += en.speed * gameSpeedMult;
            if(en.type === 'kamikaze') {
                if(en.x < player.x) en.x += 1.5; else en.x -= 1.5;
            }

            if(Math.hypot(en.x - player.x, en.y - player.y) < 30) {
                onPlayerHit();
                enemies.splice(ei, 1);
            }

            bullets.forEach((b, bi) => {
                if(Math.hypot(en.x - b.x, en.y - b.y) < 30) {
                    en.hp--;
                    bullets.splice(bi, 1);
                    createExplosion(en.x, en.y, en.color, 5);
                    if(en.hp <= 0) {
                        let rand = Math.random();
                        if(rand < 0.1) bonuses.push({x: en.x, y: en.y, type: 'triple'});
                        else if(rand < 0.15) bonuses.push({x: en.x, y: en.y, type: 'shield'});
                        enemies.splice(ei, 1);
                        score += (en.type === 'tank' ? 30 : 10);
                        scoreEl.innerText = score;
                    }
                }
            });
            if(en.y > canvas.height + 50) enemies.splice(ei, 1);
        });

        // Colisión Jefe
        if(boss) {
            bullets.forEach((b, bi) => {
                if(Math.hypot(boss.x - b.x, boss.y - b.y) < 60) {
                    boss.hp--; bullets.splice(bi, 1);
                    createExplosion(b.x, b.y, "#f0f", 3);
                    if(boss.hp <= 0) {
                        createExplosion(boss.x, boss.y, "#f0f", 40);
                        boss = null; score += 200; scoreEl.innerText = score;
                    }
                }
            });
        }

        // Bonus
        bonuses.forEach((bn, i) => {
            bn.y += 3;
            if(Math.hypot(bn.x - player.x, bn.y - player.y) < 30) {
                if(bn.type === 'triple') player.tripleEndTime = now + 3000;
                else player.shieldEndTime = now + 5000;
                bonuses.splice(i, 1);
            }
        });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff"; stars.forEach(s => ctx.fillRect(s.x, s.y, s.s, s.s));

        particles.forEach(p => {
            ctx.globalAlpha = p.life / 30;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 3, 3);
        });
        ctx.globalAlpha = 1;

        bonuses.forEach(bn => {
            ctx.fillStyle = bn.type === 'triple' ? "#ff0" : "#0ff";
            ctx.beginPath(); ctx.arc(bn.x, bn.y, 14, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#000"; ctx.font = "bold 12px Arial";
            ctx.fillText(bn.type === 'triple' ? "3X" : "S", bn.x-7, bn.y+5);
        });

        if(boss) {
            ctx.fillStyle = "#a0f"; ctx.beginPath();
            ctx.moveTo(boss.x, boss.y + 50); ctx.lineTo(boss.x - 70, boss.y - 30); ctx.lineTo(boss.x + 70, boss.y - 30); ctx.fill();
            ctx.fillStyle = "#0f0"; ctx.fillRect(boss.x - 40, boss.y - 50, (boss.hp/boss.maxHp)*80, 6);
        }

        ctx.fillStyle = "#0ff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
        ctx.fillStyle = "#f33"; enemyBombs.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 7, 0, Math.PI*2); ctx.fill(); });

        enemies.forEach(en => {
            ctx.fillStyle = en.color;
            ctx.beginPath();
            if(en.type === 'tank') ctx.fillRect(en.x-25, en.y-15, 50, 30);
            else { ctx.moveTo(en.x, en.y + 20); ctx.lineTo(en.x-18, en.y-12); ctx.lineTo(en.x+18, en.y-12); ctx.fill(); }
        });

        // JUGADOR
        const now = Date.now();
        if (now > player.invincibleUntil || Math.floor(now/100) % 2 === 0) {
            ctx.fillStyle = now < player.tripleEndTime ? "#0f0" : "#00d2ff";
            ctx.beginPath();
            ctx.moveTo(player.x, player.y-25); ctx.lineTo(player.x-22, player.y+15); ctx.lineTo(player.x, player.y+5); ctx.lineTo(player.x+22, player.y+15);
            ctx.fill();
            if (now < player.shieldEndTime) {
                ctx.strokeStyle = "#0ff"; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(player.x, player.y, 35, 0, Math.PI*2); ctx.stroke();
            }
        }
    }

    function gameOver() {
        gameActive = false;
        menu.style.display = "block";
        document.getElementById("title").innerText = "¡FIN DE LA MISIÓN!";
        document.getElementById("msg").innerHTML = "Puntos: " + score + "<br>Pulsa 'R' para revivir";
        if(score > highscore) { highscore = score; localStorage.setItem("sw_master_score", highscore); highscoreEl.innerText = highscore; }
    }

    function loop() { update(); draw(); if(gameActive) requestAnimationFrame(loop); }
</script>
</body>
</html>
