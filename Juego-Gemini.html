<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Space War: Balanced Edition</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #game-container { position: relative; border: 3px solid #00d2ff; box-shadow: 0 0 20px #00d2ff; }
        canvas { background: #010103; display: block; }
        .ui { position: absolute; top: 10px; left: 15px; width: 92%; display: flex; justify-content: space-between; pointer-events: none; font-size: 18px; z-index: 10; font-weight: bold; color: #00d2ff; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 15px; border: 2px solid #00d2ff; z-index: 20; }
        #level-up { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 30px; color: #ff0; display: none; z-index: 5; text-shadow: 0 0 10px #ff0; }
        button { padding: 15px 30px; font-size: 18px; background: #00d2ff; border: none; cursor: pointer; border-radius: 5px; font-weight: bold; color: #000; }
        .hint { margin-top: 15px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="ui">
            <div>PUNTOS: <span id="score">0</span> | NIVEL: <span id="vel-stat">1</span></div>
            <div>RECORD: <span id="highscore">0</span></div>
        </div>
        <div id="level-up">¡VELOCIDAD AUMENTADA!</div>
        <canvas id="gameCanvas" width="600" height="750"></canvas>
        <div id="menu">
            <h1 id="title">SPACE WAR</h1>
            <p id="msg">FLECHAS: Moverse | ESPACIO: Disparar<br>¡Jefe cada 300 pts!</p>
            <button onclick="startGame()">INICIAR JUEGO</button>
            <p class="hint">Cuando mueras, pulsa <b>"R"</b> para reiniciar</p>
        </div>
    </div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const highscoreEl = document.getElementById("highscore");
    const velEl = document.getElementById("vel-stat");
    const menu = document.getElementById("menu");
    const lvlUpMsg = document.getElementById("level-up");

    let gameActive = false, score = 0, highscore = localStorage.getItem("sw_final_score") || 0;
    let gameSpeedMult = 1;
    highscoreEl.innerText = highscore;

    let player = { x: 300, y: 650, speed: 7, tripleEndTime: 0 };
    let bullets = [], enemies = [], enemyBombs = [], stars = [], bonuses = [], boss = null;
    let keys = {};

    // Estrellas iniciales
    for(let i=0; i<100; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2, v: Math.random()*2+1});

    window.onkeydown = e => { 
        keys[e.code] = true; 
        if(e.code === "Space" && gameActive) shoot();
        // REINICIO CON TECLA R
        if(e.code === "KeyR" && !gameActive) startGame();
    };
    window.onkeyup = e => keys[e.code] = false;

    function shoot() {
        const now = Date.now();
        if(now < player.tripleEndTime) {
            bullets.push({x: player.x, y: player.y, vx: -4, vy: -12}, {x: player.x, y: player.y, vx: 0, vy: -12}, {x: player.x, y: player.y, vx: 4, vy: -12});
        } else {
            bullets.push({x: player.x, y: player.y, vx: 0, vy: -12});
        }
    }

    function startGame() {
        score = 0; gameSpeedMult = 1; 
        enemies = []; bullets = []; enemyBombs = []; bonuses = []; boss = null;
        player.x = 300; player.y = 650;
        gameActive = true; menu.style.display = "none";
        loop();
    }

    function update() {
        if(!gameActive) return;

        // Movimiento
        if(keys["ArrowLeft"] && player.x > 25) player.x -= player.speed;
        if(keys["ArrowRight"] && player.x < canvas.width - 25) player.x += player.speed;
        if(keys["ArrowUp"] && player.y > 25) player.y -= player.speed;
        if(keys["ArrowDown"] && player.y < canvas.height - 25) player.y += player.speed;

        // Aumento de velocidad cada 100 puntos (más suave ahora)
        let newMult = 1 + (Math.floor(score / 100) * 0.15);
        if (newMult > gameSpeedMult) {
            gameSpeedMult = newMult;
            velEl.innerText = Math.floor(gameSpeedMult * 10) / 10;
            lvlUpMsg.style.display = "block";
            setTimeout(() => lvlUpMsg.style.display = "none", 1000);
        }

        stars.forEach(s => { s.y += s.v * gameSpeedMult; if(s.y > canvas.height) s.y = 0; });

        bullets.forEach((b, i) => {
            b.y += b.vy; b.x += b.vx;
            if(b.y < -20 || b.x < 0 || b.x > canvas.width) bullets.splice(i, 1);
        });

        // JEFE CADA 300 PUNTOS
        if(score > 0 && score % 300 === 0 && !boss) {
            boss = { x: canvas.width/2, y: -100, hp: 30, maxHp: 30, dir: 1 };
        }

        if(boss) {
            if(boss.y < 100) boss.y += 2;
            boss.x += 4 * boss.dir * gameSpeedMult;
            if(boss.x > canvas.width - 70 || boss.x < 70) boss.dir *= -1;
            if(Math.random() < 0.05 * gameSpeedMult) enemyBombs.push({ x: boss.x, y: boss.y + 30, vy: 5 });
        }

        enemyBombs.forEach((bomb, i) => {
            bomb.y += 5 * gameSpeedMult;
            if(Math.hypot(bomb.x - player.x, bomb.y - player.y) < 22) gameOver();
            if(bomb.y > canvas.height) enemyBombs.splice(i, 1);
        });

        // Generación de enemigos normales
        if(!boss && Math.random() < 0.04 * gameSpeedMult) {
            enemies.push({ x: Math.random()*canvas.width, y: -40, speed: 3 * gameSpeedMult });
        }

        enemies.forEach((en, ei) => {
            en.y += en.speed;
            if(Math.hypot(en.x - player.x, en.y - player.y) < 32) gameOver();

            bullets.forEach((b, bi) => {
                if(Math.hypot(en.x - b.x, en.y - b.y) < 28) {
                    if(Math.random() < 0.12) bonuses.push({x: en.x, y: en.y});
                    enemies.splice(ei, 1); bullets.splice(bi, 1);
                    score += 10; scoreEl.innerText = score;
                }
            });
            if(en.y > canvas.height + 50) enemies.splice(ei, 1);
        });

        if(boss) {
            bullets.forEach((b, bi) => {
                if(Math.hypot(boss.x - b.x, boss.y - b.y) < 60) {
                    boss.hp--; bullets.splice(bi, 1);
                    if(boss.hp <= 0) { boss = null; score += 100; scoreEl.innerText = score; }
                }
            });
        }

        bonuses.forEach((bn, i) => {
            bn.y += 3;
            if(Math.hypot(bn.x - player.x, bn.y - player.y) < 30) {
                player.tripleEndTime = Date.now() + 3000; // 3 SEGUNDOS
                bonuses.splice(i, 1);
            }
        });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff"; stars.forEach(s => ctx.fillRect(s.x, s.y, s.s, s.s));

        // Bonus
        bonuses.forEach(bn => {
            ctx.fillStyle = "#ff0"; ctx.beginPath(); ctx.arc(bn.x, bn.y, 14, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#000"; ctx.font = "bold 14px Arial"; ctx.fillText("3X", bn.x-9, bn.y+5);
        });

        // Jefe
        if(boss) {
            ctx.fillStyle = "#a0f";
            ctx.beginPath();
            ctx.moveTo(boss.x, boss.y + 50); ctx.lineTo(boss.x - 70, boss.y - 30); ctx.lineTo(boss.x + 70, boss.y - 30);
            ctx.fill();
            // Vida
            ctx.fillStyle = "#444"; ctx.fillRect(boss.x - 40, boss.y - 50, 80, 6);
            ctx.fillStyle = "#0f0"; ctx.fillRect(boss.x - 40, boss.y - 50, (boss.hp/boss.maxHp)*80, 6);
        }

        // Balas y Bombas
        ctx.fillStyle = "#0ff"; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); });
        ctx.fillStyle = "#f33"; enemyBombs.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 7, 0, Math.PI*2); ctx.fill(); });

        // Enemigos Normales
        enemies.forEach(en => {
            ctx.fillStyle = "#f55"; ctx.beginPath();
            ctx.moveTo(en.x, en.y + 20); ctx.lineTo(en.x - 18, en.y - 12); ctx.lineTo(en.x + 18, en.y - 12); ctx.fill();
        });

        // Jugador
        const tripleActivo = Date.now() < player.tripleEndTime;
        ctx.fillStyle = tripleActivo ? "#0f0" : "#00d2ff";
        if(tripleActivo) { ctx.shadowBlur = 15; ctx.shadowColor = "#0f0"; }
        ctx.beginPath();
        ctx.moveTo(player.x, player.y - 25); ctx.lineTo(player.x - 22, player.y + 15); ctx.lineTo(player.x, player.y + 5); ctx.lineTo(player.x + 22, player.y + 15);
        ctx.fill();
        ctx.shadowBlur = 0;
    }

    function gameOver() {
        gameActive = false;
        menu.style.display = "block";
        document.getElementById("title").innerText = "¡NAVE DERRIBADA!";
        document.getElementById("msg").innerHTML = "Puntos: " + score + "<br>Presiona <b>'R'</b> para Reintentar";
        if(score > highscore) { highscore = score; localStorage.setItem("sw_final_score", highscore); highscoreEl.innerText = highscore; }
    }

    function loop() {
        update();
        draw();
        if(gameActive) requestAnimationFrame(loop);
    }
</script>
</body>
</html>